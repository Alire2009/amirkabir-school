<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>دبیرستان امیرکبیر</title>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      margin: 0;
      direction: rtl;
      background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
      color: #eee;
    }
    header {
      background: rgba(0,0,0,0.6);
      padding: 10px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #fff;
    }
    #loginArea, #app { display: none; }
    #loginArea.active { display: flex; justify-content: center; align-items: center; height: 100vh; }
    .login-box {
      background: rgba(255,255,255,0.1);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      text-align: center;
      width: 300px;
    }
    .login-box input {
      width: 90%;
      margin: 8px 0;
      padding: 10px;
      border: none;
      border-radius: 10px;
    }
    .login-box button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background: #4caf50;
      color: #fff;
      cursor: pointer;
    }
    nav {
      background: rgba(0,0,0,0.8);
      display: flex;
      gap: 10px;
      padding: 10px;
    }
    nav button {
      background: #2196f3;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
    }
    section { padding: 20px; display: none; }
    section.active { display: block; }
    .card {
      background: rgba(255,255,255,0.08);
      padding: 15px;
      border-radius: 15px;
      margin: 10px 0;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    input, textarea, select {
      border-radius: 8px;
      padding: 8px;
      margin: 5px 0;
      border: none;
    }
    button { transition: 0.3s; }
    button:hover { opacity: 0.85; }
  </style>
</head>
<body>
  <header>🎓 سامانه دبیرستان امیرکبیر</header>

  <!-- صفحه ورود -->
  <div id="loginArea" class="active">
    <div class="login-box">
      <h2>ورود به سامانه</h2>
      <input id="username" placeholder="نام کاربری">
      <input id="password" type="password" placeholder="رمز عبور">
      <button onclick="login()">ورود</button>
    </div>
  </div>

  <!-- اپلیکیشن اصلی -->
  <div id="app">
    <nav>
      <button onclick="show('dashboard')">🏠 داشبورد</button>
      <button onclick="show('news')">📰 اخبار</button>
      <button onclick="show('gallery')">🖼️ گالری</button>
      <button onclick="show('poll')">📊 نظرسنجی</button>
      <button onclick="show('attendance')">📋 حضور و غیاب</button>
      <button onclick="show('grades')">📑 کارنامه</button>
      <button id="m-users" onclick="show('users')">⚙️ مدیریت</button>
      <button onclick="show('chat')">💬 پیام‌ها</button>
    </nav>

    <section id="dashboard" class="active">
      <h2>خوش آمدید</h2>
      <p id="userBar"></p>
      <div class="card">به سامانه جامع دبیرستان امیرکبیر خوش آمدید 🌹</div>
    </section>

    <section id="news">
      <h2>اخبار و اطلاعیه‌ها</h2>
      <div id="newsList"></div>
      <div id="newsForm" class="card"></div>
    </section>

    <section id="gallery">
      <h2>گالری تصاویر</h2>
      <div id="galleryList"></div>
      <div id="galleryForm" class="card"></div>
    </section>

    <section id="poll">
      <h2>نظرسنجی</h2>
      <div id="pollContent"></div>
    </section>

    <section id="attendance">
      <h2>حضور و غیاب</h2>
      <div id="attendContent"></div>
    </section>

    <section id="grades">
      <h2>کارنامه</h2>
      <div id="gradesContent"></div>
    </section>

    <section id="users">
      <h2>مدیریت کاربران</h2>
      <div id="usersContent"></div>
    </section>

    <section id="chat">
      <h2>پیام‌ها</h2>
      <div id="chatList"></div>
      <div id="chatForm" class="card"></div>
    </section>
  </div>

  <script>
    // داده‌های پیش‌فرض
    let state = JSON.parse(localStorage.getItem("amirkabir_v3") || "{}");
    if(!state.users){
      state = {
        users:{
          "admin":{password:"1234",role:"admin",name:"مدیر"},
          "teacher":{password:"abcd",role:"teacher",name:"معلم"},
          "student":{password:"1111",role:"student",name:"دانش‌آموز"},
          "student2":{password:"2222",role:"student",name:"دانش‌آموز۲"}
        },
        news:[], gallery:[], poll:{q:"از مدرسه راضی هستید؟",yes:0,no:0},
        attendance:{}, grades:{}, chat:[]
      };
    }
    let currentUser=null;

    function save(){ localStorage.setItem("amirkabir_v3", JSON.stringify(state)); }

    // نرمال‌سازی ورودی (اعداد فارسی → انگلیسی، trim، lowercase)
    function normalizeInput(s){
      if(!s) return "";
      s = String(s).trim();
      const persian = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
      const arabic  = ['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'];
      for(let i=0;i<10;i++){
        s = s.split(persian[i]).join(String(i));
        s = s.split(arabic[i]).join(String(i));
      }
      return s;
    }

    // ورود
    function login(){
      let rawUser=document.getElementById("username").value;
      let rawPass=document.getElementById("password").value;
      let uNorm=normalizeInput(rawUser).toLowerCase();
      let pNorm=normalizeInput(rawPass);
      let userKey=Object.keys(state.users).find(k=>k.toLowerCase()===uNorm);
      if(!userKey){ alert("نام کاربری یافت نشد"); return; }
      let stored=normalizeInput(state.users[userKey].password);
      if(stored===pNorm){
        currentUser={username:userKey,role:state.users[userKey].role,name:state.users[userKey].name};
        document.getElementById("loginArea").style.display="none";
        document.getElementById("app").style.display="block";
        document.getElementById("userBar").textContent=`${currentUser.name} (${currentUser.role})`;
        if(currentUser.role!=="admin") document.getElementById("m-users").style.display="none";
        renderAll();
      } else alert("رمز عبور اشتباه است");
    }

    // تغییر صفحه
    function show(id){
      document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // رندر کل بخش‌ها
    function renderAll(){ renderNews(); renderGallery(); renderPoll(); renderAttendance(); renderGrades(); renderUsers(); renderChat(); }

    // --- اخبار
    function renderNews(){
      let list=document.getElementById("newsList");
      list.innerHTML=state.news.map(n=>`<div class="card">${n}</div>`).join("");
      let form=document.getElementById("newsForm");
      form.innerHTML="";
      if(currentUser.role!=="student"){
        form.innerHTML=`<input id="newNews" placeholder="خبر جدید"><button onclick="addNews()">افزودن</button>`;
      }
    }
    function addNews(){ let t=document.getElementById("newNews").value.trim(); if(t){state.news.push(t); save(); renderNews();} }

    // --- گالری
    function renderGallery(){
      let list=document.getElementById("galleryList");
      list.innerHTML=state.gallery.map(u=>`<img src="${u}" style="max-width:150px;margin:5px;border-radius:10px">`).join("");
      let form=document.getElementById("galleryForm");
      form.innerHTML="";
      if(currentUser.role!=="student"){
        form.innerHTML=`<input id="newImg" placeholder="آدرس تصویر"><button onclick="addImg()">افزودن</button>`;
      }
    }
    function addImg(){ let u=document.getElementById("newImg").value.trim(); if(u){state.gallery.push(u); save(); renderGallery();} }

    // --- نظرسنجی
    function renderPoll(){
      let p=state.poll;
      let div=document.getElementById("pollContent");
      div.innerHTML=`<div class="card"><b>${p.q}</b><br>
        بله: ${p.yes} / خیر: ${p.no}<br>
        <button onclick="vote('yes')">بله</button> <button onclick="vote('no')">خیر</button></div>`;
    }
    function vote(ans){ state.poll[ans]++; save(); renderPoll(); }

    // --- حضور و غیاب
    function renderAttendance(){
      let div=document.getElementById("attendContent");
      if(currentUser.role==="teacher"||currentUser.role==="admin"){
        div.innerHTML=Object.keys(state.users).filter(u=>state.users[u].role==="student")
          .map(s=>`<label><input type="checkbox" onchange="markAttend('${s}',this.checked)" ${state.attendance[s]?"checked":""}> ${s}</label>`).join("<br>");
      } else {
        div.innerHTML=state.attendance[currentUser.username]?"شما امروز حاضر هستید ✅":"غایب ❌";
      }
    }
    function markAttend(s,val){ state.attendance[s]=val; save(); }

    // --- کارنامه
    function renderGrades(){
      let div=document.getElementById("gradesContent");
      if(currentUser.role==="student"){
        let g=state.grades[currentUser.username]||{};
        div.innerHTML=Object.keys(g).map(sub=>`<div>${sub}: ${g[sub]}</div>`).join("")||"هنوز نمره‌ای ثبت نشده";
      } else {
        div.innerHTML=Object.keys(state.users).filter(u=>state.users[u].role==="student")
          .map(s=>`<div class="card"><b>${s}</b><br>
          <input id="g_${s}_math" placeholder="ریاضی" value="${(state.grades[s]||{}).math||""}">
          <input id="g_${s}_sci" placeholder="علوم" value="${(state.grades[s]||{}).sci||""}">
          <button onclick="saveGrade('${s}')">ثبت</button></div>`).join("");
      }
    }
    function saveGrade(s){
      state.grades[s]={math:document.getElementById(`g_${s}_math`).value,sci:document.getElementById(`g_${s}_sci`).value};
      save(); renderGrades();
    }

    // --- مدیریت کاربران
    function renderUsers(){
      let div=document.getElementById("usersContent");
      if(currentUser.role!=="admin"){div.innerHTML="دسترسی ندارید"; return;}
      div.innerHTML=Object.keys(state.users).map(u=>`<div>${u} (${state.users[u].role})</div>`).join("")+
      `<hr><input id="nu" placeholder="نام کاربری"><input id="np" placeholder="رمز"><select id="nr">
        <option value="student">دانش‌آموز</option><option value="teacher">معلم</option><option value="admin">مدیر</option></select>
        <button onclick="addUser()">افزودن</button>`;
    }
    function addUser(){
      let u=document.getElementById("nu").value.trim();
      let p=document.getElementById("np").value.trim();
      let r=document.getElementById("nr").value;
      if(u&&p){state.users[u]={password:p,role:r,name:u}; save(); renderUsers();}
    }

    // --- پیام‌ها
    function renderChat(){
      let list=document.getElementById("chatList");
      list.innerHTML=state.chat.map(c=>`<div class="card"><b>${c.user}:</b> ${c.text}</div>`).join("");
      let form=document.getElementById("chatForm");
      form.innerHTML=`<input id="msg"><button onclick="sendMsg()">ارسال</button>`;
    }
    function sendMsg(){ let t=document.getElementById("msg").value.trim(); if(t){state.chat.push({user:currentUser.name,text:t}); save(); renderChat();} }
  </script>
</body>
</html>
